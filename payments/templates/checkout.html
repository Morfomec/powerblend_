{% extends 'payment_base.html' %}
{% load static %}
{% block title %}Checkout - POWERBLEND{% endblock %}
{% block extra_css %}

<style>
/* Modal Specific Styles - Extends Address Page CSS */
#addAddressModal .modal-content {
    border: 1px solid #e9ecef;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}

#addAddressModal .form-label {
    color: var(--primary-solid);
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#addAddressModal .form-control, 
#addAddressModal .form-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem 1.2rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
    color: var(--primary-solid);
    font-weight: 500;
}

#addAddressModal .form-control:focus, 
#addAddressModal .form-select:focus {
    border-color: var(--primary-solid);
    box-shadow: 0 0 0 0.2rem rgba(0, 57, 66, 0.25);
    outline: none;
}

#addAddressModal .form-control::placeholder {
    color: #6c757d;
    font-weight: normal;
}

#addAddressModal .form-group {
    margin-bottom: 1.5rem;
}

/* Address Type in Modal */
#addAddressModal .address-type-group {
    margin-bottom: 2rem;
}

#addAddressModal .address-type-options {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

#addAddressModal .address-type-option {
    flex: 1;
    position: relative;
}

#addAddressModal .address-type-radio {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

#addAddressModal .address-type-label {
    display: block;
    background: var(--light-bg);
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    color: var(--primary-solid);
    height: 80px;
}

#addAddressModal .address-type-label:hover {
    border-color: var(--primary-color);
    background: rgba(0, 57, 66, 0.05);
}

#addAddressModal .address-type-radio:checked + .address-type-label {
    border-color: var(--primary-solid);
    background: var(--primary-solid);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 57, 66, 0.3);
}

#addAddressModal .address-type-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    display: block;
}

/* Default Checkbox in Modal */
#addAddressModal .default-checkbox-group {
    background: var(--light-bg);
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1.5rem 0 0 0;
    border: 1px solid #e9ecef;
}

#addAddressModal .default-checkbox {
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: pointer;
}

#addAddressModal .checkbox-input {
    width: 20px;
    height: 20px;
    border: 2px solid var(--primary-solid);
    border-radius: 4px;
    appearance: none;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

#addAddressModal .checkbox-input:checked {
    background: var(--primary-solid);
}

#addAddressModal .checkbox-input:checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 14px;
}

#addAddressModal .checkbox-label {
    color: var(--primary-solid);
    font-weight: 600;
    margin: 0;
    cursor: pointer;
}

/* Modal Buttons */
#addAddressModal .btn-add-address {
    background: var(--primary-solid);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
}

#addAddressModal .btn-add-address:hover {
    background: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 57, 66, 0.3);
}

#addAddressModal .btn-cancel {
    background: transparent;
    color: var(--primary-solid);
    border: 2px solid var(--primary-solid);
    padding: 1rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    text-decoration: none;
}

#addAddressModal .btn-cancel:hover {
    background: var(--primary-solid);
    color: white;
    transform: translateY(-2px);
}

/* Validation Messages in Modal */
#addAddressModal .invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: var(--danger-color);
    font-weight: 500;
}

/* Responsive Modal */
@media (max-width: 768px) {
    #addAddressModal .modal-body {
        padding: 1.5rem;
    }
    
    #addAddressModal .address-type-options {
        flex-direction: column;
    }
    
    #addAddressModal .address-type-label {
        padding: 1rem;
    }
    
    #addAddressModal .modal-footer {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    #addAddressModal .modal-footer button {
        width: 100%;
    }
}
</style>

<style>


.btn-add-address {
    width: 100%;
    padding: 15px;
    border: 2px dashed var(--primary-solid);
    background: var(--light-bg);
    color: var(--primary-solid);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 600;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-add-address:hover {
    background: var(--primary-solid);
    color: white;
    border-color: var(--primary-solid);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 57, 66, 0.3);
}



/* Base Alert Styles */
.custom-alert {
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    animation: slideDown 0.4s ease-out;
    border: 2px solid rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
}

.custom-alert::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: shimmer 3s infinite;
}

.custom-alert i {
    font-size: 1.1rem;
    animation: pulse 1.5s ease-in-out infinite;
    flex-shrink: 0;
}

/* Error/Danger Alert */
.alert-error {
    background: linear-gradient(135deg, #dc3545, #c82333);
    box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);
}

/* Success Alert */
.alert-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
}

/* Warning Alert */
.alert-warning {
    background: linear-gradient(135deg, #ffc107, #ff9800);
    box-shadow: 0 4px 20px rgba(255, 193, 7, 0.3);
}

/* Info Alert */
.alert-info {
    background: linear-gradient(135deg, #17a2b8, #138496);
    box-shadow: 0 4px 20px rgba(23, 162, 184, 0.3);
}

/* Animations */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.15);
    }
}

@keyframes shimmer {
    0% {
        left: -100%;
    }
    100% {
        left: 100%;
    }
}

/* Solid Background Variants */
.custom-alert.solid.alert-error {
    background: #dc3545;
    border: 2px solid #bd2130;
}

.custom-alert.solid.alert-success {
    background: #28a745;
    border: 2px solid #1e7e34;
}

.custom-alert.solid.alert-warning {
    background: #ffc107;
    border: 2px solid #e0a800;
}

.custom-alert.solid.alert-info {
    background: #17a2b8;
    border: 2px solid #117a8b;
}

/* Light Background Variants with Dark Text */
.custom-alert.light {
    border-left-width: 3px;
}

.custom-alert.light.alert-error {
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
    color: #dc3545;
    border: 2px solid #dc3545;
    border-left-width: 3px;
}

.custom-alert.light.alert-error i {
    color: #dc3545;
}

.custom-alert.light.alert-success {
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
    color: #28a745;
    border: 2px solid #28a745;
    border-left-width: 3px;
}

.custom-alert.light.alert-success i {
    color: #28a745;
}

.custom-alert.light.alert-warning {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
    color: #856404;
    border: 2px solid #ffc107;
    border-left-width: 3px;
}

.custom-alert.light.alert-warning i {
    color: #856404;
}

.custom-alert.light.alert-info {
    background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05));
    color: #17a2b8;
    border: 2px solid #17a2b8;
    border-left-width: 3px;
}

.custom-alert.light.alert-info i {
    color: #17a2b8;
}

/* Responsive */
@media (max-width: 576px) {
    .custom-alert {
        padding: 1rem;
        font-size: 0.9rem;
        gap: 0.5rem;
    }
    
    .custom-alert i {
        font-size: 1.1rem;
    }
}
</style>


{% endblock extra_css %}
{% block body %} 

{% include 'includes/header_user_profile_base.html' %}
    <head><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"></head>


    <div class="checkout-container">
        <div class="row">
            <!-- Left Column - Checkout Form -->
            <div class="col-lg-8">
                <!-- Delivery Address Section -->
                <div class="checkout-card">
                    <h3 class="card-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Delivery Address
                    </h3>



                    {% if messages %}
                        {% for message in messages %}
                            {% if 'checkout-wallet_insufficient' in message.tags or 'coupon_applied_successfull' in message.tags or 'coupon_applied_not_minimum_meet' in message.tags or 'address_added' in message.tags or 'invalid_coupon' in message.tags or 'otp-success' in message.tags or 'remove_coupon' in message.tags  or  'cod_1000' in message.tags or 'coupn_used' in message.tags %}
                                <div class="custom-alert 
                                    {% if 'error' in message.tags or 'danger' in message.tags or 'checkout-wallet_insufficient' in message.tags %}alert-error
                                    {% elif 'success' in message.tags or 'otp-success' in message.tags %}alert-success
                                    {% elif 'warning' in message.tags %}alert-warning
                                    {% elif 'info' in message.tags %}alert-info
                                    {% else %}alert-error{% endif %} 
                                    text-uppercase text-center mb-5" id="alert-{{ forloop.counter }}">
                                    <i class="fas 
                                        {% if 'error' in message.tags or 'danger' in message.tags or 'checkout-wallet_insufficient' in message.tags %}fa-exclamation-circle
                                        {% elif 'success' in message.tags or 'otp-success' in message.tags %}fa-check-circle
                                        {% elif 'warning' in message.tags %}fa-exclamation-triangle
                                        {% elif 'info' in message.tags %}fa-info-circle
                                        {% else %}fa-exclamation-circle{% endif %}"></i>
                                    <span>{{ message }}</span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                                        
                    <!-- Existing Address -->
                    {% if default_address %}
                        <div class="address-card selected" onclick="selectAddress(this)">
                            <div class="address-type">
                                {% if default_address.address_type == 'HOME' %}
                                    <i class="fas fa-home me-1"></i>Home
                                {% elif default_address.address_type == 'OFFICE' %}
                                    <i class="fas fa-building me-1"></i>Office
                                {% else %}
                                    <i class="fas fa-map-marker-alt me-1"></i>{{ default_address.address_type|title }}
                                {% endif %}
                            </div>

                            <div class="address-name">{{ default_address.full_name }}</div>
                            <div class="address-details">
                                {{ default_address.address.line1 }}{% if default_address.address_line2 %}, {{ default_address.address_line2 }}{% endif %}<br>
                                {{ default_address.city }}, {{ default_address.state }} {{ default_address.postal_code }} <br>
                                {{ default_address.country }}    
                            </div>
                            <div class="address-phone">
                                <i class="fas fa-phone me-1"></i>{{ default_address.mobile }}    {% if default_address.second_mobile %}   &nbsp;&nbsp; <i class="fas fa-phone me-1"></i>{{ default_address.second_mobile }}{% endif %}
                            </div>
                            <div class="address-actions">
                                <a href="{% url 'address_update' default_address.id %}?next={{ request.path }}" class="btn btn-edit">
                                    <i class="fas fa-edit me-1"></i>EDIT
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <h3 class="text-muted">No default address. Please add one.</h3><br>
                    {% endif %}

                    <!-- Add New Address Button -->
                     <!-- <a href="{% url 'address_create' %}?next={{ request.path }}" class="btn-add-address">
                        <i class="fas fa-plus me-2"></i> ADD NEW ADDRESS
                     </a> -->
                     <button type="button" class="btn-add-address" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                        <i class="fas fa-plus me-2"></i> ADD NEW ADDRESS
                    </button>



                    
                </div>

                <!-- Apply Coupon Section -->
                <div class="checkout-card">
                    <h3 class="card-title">
                        <i class="fas fa-ticket-alt"></i>
                        Apply Coupon
                    </h3>
                    
                    <form method="POST">
                        {% csrf_token %}
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <!-- input name must match form field -->
                                <input type="text" name="code" class="coupon-input w-100" placeholder="Enter Coupon Code" value="{{ coupon_form.code.value|default_if_none:'' }}">
                            </div>
                            <div class="col-md-4">
                                <button type="submit" name="apply_coupon" class="btn-apply-coupon w-100">
                                    <i class="fas fa-tags me-1"></i>APPLY
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="coupon-message" id="couponMessage"></div>
                    
                    <!-- Available Coupons Section -->
                    <div class="available-coupons-section mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="available-coupons-title mb-0">
                                <i class="fas fa-gift me-2"></i>Available Coupons
                            </h5>
                            <button class="btn-view-coupons" onclick="toggleCoupons()">
                                <span id="toggleText">View All</span>
                                <i class="fas fa-chevron-down ms-1" id="toggleIcon"></i>
                            </button>
                        </div>
                        
                        <div class="coupons-list" id="couponsList" style="display: none;">
                            {% if available_coupons %}
                                {% for coupon in available_coupons %}
                                <div class="coupon-card">
                                    <div class="coupon-left">
                                        <div class="coupon-code-badge">{{ coupon.code }}</div>
                                        <div class="coupon-discount">
                                            ‚Çπ{{ coupon.discount_amount }} OFF
                                        </div>
                                    </div>
                                    <div class="coupon-middle">
                                        <div class="coupon-description">{{ coupon.description }}</div>
                                        <div class="coupon-details">
                                            {% if coupon.minimum_amount %}
                                                <span class="coupon-condition">
                                                    <i class="fas fa-shopping-cart me-1"></i>Min Order: ‚Çπ{{ coupon.minimum_amount }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="coupon-validity">
                                            <i class="fas fa-clock me-1"></i>Valid till: {{ coupon.valid_to|date:"d M, Y" }}
                                        </div>
                                    </div>
                                    <!-- <div class="coupon-right">
                                        <button class="btn-apply-this-coupon" onclick="applyThisCoupon('{{ coupon.code }}')">
                                            APPLY
                                        </button>
                                    </div> -->
                                    <div class="coupon-right">
                                        <button type="button" class="btn-apply-this-coupon" onclick="copyCoupon('{{ coupon.code }}')">
                                            COPY
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-coupons">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>No coupons available at the moment</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="col-lg-4">
                <div class="order-summary">
                    <h3 class="order-title">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Your Order
                    </h3>
                    
                    <!-- Product Items -->
                    {% for item in basket_items %}
                    <div class="product-item">
                        {% with item.variant.product.images.first as image %}
                            {% if image %}
                                <img src="{{ image.image.url }} " alt="{{ item.variant.product.name }}" class="product-image">
                            {% else %}
                                <img src="{% static 'images/placeholder.png' %}" alt="No Image">
                            {% endif %}
                        {% endwith %}
                        <div class="product-details">
                            <h6>{{ item.variant.product.name }}</h6>
                            <div class="product-qty">Qty: {{ item.quantity }}</div>
                        </div>
                        <div class="product-price">‚Çπ{{ item.subtotal|floatformat:2 }}</div>
                    </div>
                    {% empty %}
                    <h2>Your checkout is empty</h2>
                    {% endfor %}



                    <!-- Price Breakdown -->
                    <div class="mt-3">
                        <div class="price-row">
                            <span>Subtotal</span>
                            <span>‚Çπ{{ subtotal|floatformat:2  }}</span>
                        </div>
                        <div class="price-row">
                            <span>Shipping</span>
                            {% if shipping == 0 %}
                                <span class="text-success">FREE</span>
                            {% else %}
                                <span>‚Çπ{{ shipping|floatformat:2  }}</span>
                            {% endif %}
                        </div>
                        <div class="price-row">
                            <span>Taxes</span>
                            <span>‚Çπ{{ taxes|floatformat:2  }}</span>
                        </div>
                        <div class="price-row-wrapper">
                            <div class="price-row">
                                {% if applied_coupon %}
                                    <span>Coupon ({{ applied_coupon.code }})</span>
                                    <span class="text-warning">-‚Çπ{{ discount|floatformat:2 }}</span>
                                {% else %}                    

                                    <span>Discount</span>
                                    <span class="text-warning">‚Çπ0.00</span>
                                {% endif %}                               
                            </div>
                            {% if applied_coupon %}
                                <form method="POST" class="remove-coupon-form">
                                    {% csrf_token %}
                                    <button type="submit" name="remove_coupon" class="btn-remove-coupon">
                                        <i class="fas fa-times-circle me-1"></i>Remove Coupon
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                        <div class="price-row total">
                            <span>Total</span>
                            <span>‚Çπ{{ total|floatformat:2  }}</span>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="mt-4">
                        <form action="{% url 'checkout' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="payment_method" value="wallet">
                            <button type="submit" class="payment-button" >
                                <i class="fas fa-wallet"></i>
                                WALLET (Balance: ‚Çπ{{ wallet_balance }})
                            </button>
                        </form>

                        <form action="{{ callback_url }}" method="POST" id="razorpay-form">
                            {% csrf_token %}
                            <input type="hidden" name="payment_method" value="razorpay">
                            <button type="submit" class="payment-button" id="rzp-button">
                                <i class="fas fa-credit-card"></i>
                                RAZORPAY
                            </button>
                        </form>

                        <form action="{% url 'checkout' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="payment_method" value="cod">
                            <button type="submit" class="payment-button">
                                <i class="fas fa-money-bill-wave"></i>
                                CASH ON DELIVERY
                            </button>
                         </form>
                    </div>

                    <!-- Security Badge -->
                    <div class="text-center mt-3">
                        <small class="security-text">
                            <i class="fas fa-shield-alt me-1"></i>
                            256-bit SSL encrypted & secure payments
                        </small>
                    </div>
                </div>
            </div>


            <!-- Add Address Modal (Adding address from the checkout page itself with out leaving)-->
            <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content" style="border-radius: 12px; border: 1px solid #e9ecef;">
                        <div class="modal-header" style="background: var(--primary-solid); color: white; border-radius: 12px 12px 0 0;">
                            <h5 class="modal-title" id="addAddressModalLabel" style="font-weight: 600; font-size: 1.5rem;">
                                <i class="fas fa-map-marker-alt me-2"></i>Add New Address
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="POST" action="{% url 'checkout' %}" id="addressModalForm">
                            {% csrf_token %}
                            <div class="modal-body" style="padding: 2rem;">

                                {% if address_form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {% for error in address_form.non_field_errors %}
                                    <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                
                                <!-- Address Type Selection -->
                                <div class="address-type-group">
                                    <label class="form-label">ADDRESS TYPE *</label>
                                    <div class="address-type-options">
                                        <div class="address-type-option">
                                            <input type="radio" name="address_type" value="HOME" id="modal_type_home" class="address-type-radio" checked>
                                            <label for="modal_type_home" class="address-type-label">
                                                <span class="address-type-icon">üè†</span>
                                                Home
                                            </label>
                                        </div>
                                        <div class="address-type-option">
                                            <input type="radio" name="address_type" value="OFFICE" id="modal_type_office" class="address-type-radio">
                                            <label for="modal_type_office" class="address-type-label">
                                                <span class="address-type-icon">üè¢</span>
                                                Office
                                            </label>
                                        </div>
                                        <div class="address-type-option">
                                            <input type="radio" name="address_type" value="OTHER" id="modal_type_other" class="address-type-radio">
                                            <label for="modal_type_other" class="address-type-label">
                                                <span class="address-type-icon">üìç</span>
                                                Other
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contact Information -->
                                <div class="row">
                                    <div class="col-md-6 form-group">
                                        <label for="modal_{{ address_form.full_name.id_for_label }}" class="form-label">FULL NAME *</label>
                                        <input type="text" name="full_name" id="modal_full_name" class="form-control {% if form.full_name.errors %}is-invalid{% endif %}" placeholder="Enter your full name"
                                                value="{{ address_form.full_name.value|default_if_none:'' }}" required>
                                        {% if address_form.full_name.errors %}
                                            <div class="invalid-feedback">{{ address_form.full_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 form-group">
                                        <label for="modal_mobile" class="form-label">MOBILE  *</label>
                                        <input type="tel" name="mobile" id="modal_mobile" class="form-control {% if form.mobile.errors %}is-invalid{% endif %}" placeholder="10-digit mobile number"
                                                value="{{ address_form.mobile.value|default_if_none:'' }}" required>
                                        {% if address_form.mobile.errors %}
                                            <div class="invalid-feedback">{{ address_form.mobile.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12 form-group">
                                        <label for="modal_second_mobile" class="form-label">SECOND NUMBER</label>
                                        <input type="tel" name="second_mobile" id="modal_second_mobile" class="form-control {% if form.second_mobile.errors %}is-invalid{% endif %}" placeholder="10-digit alternate number (optional)"
                                                value="{{ address_form.second_mobile.value|default_if_none:'' }}">
                                    </div>
                                </div>

                                <!-- Address Details -->
                                <div class="form-group">
                                    <label for="modal_address" class="form-label">ADDRESS (HOUSE NO, BUILDING, STREET) *</label>
                                    <textarea name="address" id="modal_address" class="form-control {% if address_form.address.errors %}is-invalid{% endif %}" rows="2" placeholder="Enter your complete address" required>{{ address_form.address.value|default_if_none:'' }}</textarea>
                                    {% if address_form.address.errors %}
                                        <div class="invalid-feedback">{{ address_form.address.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="modal_address_line2" class="form-label">LOCALITY / AREA</label>
                                    <input type="text" name="address_line2" id="modal_address_line2" class="form-control" placeholder="Locality, Landmark (optional)">
                                </div>

                                <!-- Location Details -->
                                <div class="row">
                                    <div class="col-md-4 form-group">
                                        <label for="modal_city" class="form-label">CITY *</label>
                                        <input type="text" name="city" id="modal_city" class="form-control {% if form.city.errors %}is-invalid{% endif %}" placeholder="City" 
                                                value="{{ address_form.city.value|default_if_none:'' }}"required>
                                        {% if address_form.city.errors %}
                                            <div class="invalid-feedback">{{ address_form.city.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 form-group">
                                        <label for="modal_state" class="form-label">STATE *</label>
                                        <input type="text" name="state" id="modal_state" class="form-control {% if form.state.errors %}is-invalid{% endif %}" placeholder="State"
                                                value="{{ address_form.state.value|default_if_none:'' }}" required>
                                        {% if address_form.state.errors %}
                                            <div class="invalid-feedback">{{ address_form.state.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 form-group">
                                        <label for="modal_postal_code" class="form-label">POSTAL CODE *</label>
                                        <input type="text" name="postal_code" id="modal_postal_code" class="form-control {% if form.postal_code.errors %}is-invalid{% endif %}"" placeholder="6-digit PIN" 
                                                value="{{ address_form.postal_code.value|default_if_none:'' }}" required>
                                        {% if address_form.postal_code.errors %}
                                            <div class="invalid-feedback">{{ address_form.postal_code.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="modal_country" class="form-label">COUNTRY *</label>
                                    <input type="text" name="country" id="modal_country" class="form-control {% if form.country.errors %}is-invalid{% endif %}"" placeholder="Country"  value="{{ address_form.country.value|default_if_none:'India' }}" required>
                                    {% if address_form.country.errors %}
                                        <div class="invalid-feedback">{{ address_form.country.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <!-- Set as Default -->
                                <div class="default-checkbox-group">
                                    <label class="default-checkbox">
                                        <input type="checkbox" name="is_default" id="modal_is_default" class="checkbox-input">
                                        <span class="checkbox-label">
                                            <i class="fas fa-star me-2"></i>Set as default and use for current order
                                    </label>
                                </div>
                            </div>
                            
                            <div class="modal-footer" style="border-top: 1px solid #e9ecef; padding: 1.5rem;">
                                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal" style="flex: 1;">
                                    <i class="fas fa-times me-2"></i>CANCEL
                                </button>
                                <button type="submit" name="address_create" class="btn-add-address" style="flex: 1; margin-bottom: 0;">
                                    <i class="fas fa-save me-2"></i>SAVE ADDRESS
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>


        </div>
    </div>
{% endblock body %}

{% block extra_js %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>


{% if razorpay_order_id %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    
document.getElementById('rzp-button').onclick = function(e){
    var options = {
        "key": "{{ razorpay_merchant_key }}",
        "amount": {{ razorpay_amount }},
        "currency": "{{ currency }}",
        "name": "POWERBLEND",
        "description": "Order Payment",
        "order_id": "{{ razorpay_order_id }}",
        "prefill": {
            "name": "{{ request.user.full_name }}",
            "email": "{{ request.user.email }}"
        },
        "theme": {"color": "#0c4b65"},
        "handler": function(response){
            var form = document.getElementById('razorpay-form');

            ['razorpay_payment_id','razorpay_order_id','razorpay_signature'].forEach(function(name){
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = response[name];
                form.appendChild(input);
            });

            form.submit();
        }
    };
    var rzp = new Razorpay(options);
    rzp.open();
    e.preventDefault();
};
</script>


{% endif %}

<script>
function toggleCoupons() {
    const couponsList = document.getElementById('couponsList');
    const toggleText = document.getElementById('toggleText');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (couponsList.style.display === 'none') {
        couponsList.style.display = 'block';
        toggleText.textContent = 'Hide';
        toggleIcon.classList.remove('fa-chevron-down');
        toggleIcon.classList.add('fa-chevron-up');
    } else {
        couponsList.style.display = 'none';
        toggleText.textContent = 'View All';
        toggleIcon.classList.remove('fa-chevron-up');
        toggleIcon.classList.add('fa-chevron-down');
    }
}

function applyThisCoupon(code) {
    document.getElementById('couponInput').value = code;
    applyCoupon();
}

function copyCoupon(code) {
    navigator.clipboard.writeText(code).then(() => {
        toastr.success('Coupon code copied: ' + code);
    }).catch(() => {
        toastr.error('Failed to copy coupon code');
    });
}
</script>

<!-- Optional: Auto-dismiss script -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Select all custom alert messages
    const alerts = document.querySelectorAll(".custom-alert");
    
    alerts.forEach((alert) => {
        // Wait 5 seconds before fading out
        setTimeout(() => {
            alert.style.transition = "opacity 0.6s ease, transform 0.6s ease";
            alert.style.opacity = "0";
            alert.style.transform = "translateY(-10px)";
            
            // Remove the alert completely after fade-out
            setTimeout(() => alert.remove(), 600);
        }, 3000);
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if there are form errors
    const addressForm = document.querySelector('#addAddressModal form');
    const hasErrors = addressForm && addressForm.querySelector('.text-danger');
    
    // If there are errors, show the modal
    if (hasErrors) {
        const modal = new bootstrap.Modal(document.getElementById('addAddressModal'));
        modal.show();
    }
});
</script>



<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if there are form errors and reopen modal
    {% if address_form.errors %}
        var addressModal = new bootstrap.Modal(document.getElementById('addAddressModal'));
        addressModal.show();
    {% endif %}
    
    // Optional: Auto-hide success message after 3 seconds
    setTimeout(function() {
        var alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            if (alert.classList.contains('alert-success')) {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.remove();
                }, 500);
            }
        });
    }, 3000);
});
</script>
{% endblock extra_js %}