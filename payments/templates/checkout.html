{% extends 'payment_base.html' %}
{% load static %}
{% block title %}Checkout - POWERBLEND{% endblock %}
{% block extra_css %}{% endblock extra_css %}
{% block body %} 

{% include 'includes/header_user_profile_base.html' %}

    <div class="checkout-container">
        <div class="row">
            <!-- Left Column - Checkout Form -->
            <div class="col-lg-8">
                <!-- Delivery Address Section -->
                <div class="checkout-card">
                    <h3 class="card-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Delivery Address
                    </h3>
                    
                    <!-- Existing Address -->
                    {% if default_address %}
                        <div class="address-card selected" onclick="selectAddress(this)">
                            <div class="address-type">
                                {% if default_address.address_type == 'HOME' %}
                                    <i class="fas fa-home me-1"></i>Home
                                {% elif default_address.address_type == 'OFFICE' %}
                                    <i class="fas fa-building me-1"></i>Office
                                {% else %}
                                    <i class="fas fa-map-marker-alt me-1"></i>{{ default_address.address_type|title }}
                                {% endif %}
                            </div>

                            <div class="address-name">{{ default_address.full_name }}</div>
                            <div class="address-details">
                                {{ default_address.address.line1 }}{% if default_address.address_line2 %}, {{ default_address.address_line2 }}{% endif %}<br>
                                {{ default_address.city }}, {{ default_address.state }} {{ default_address.postal_code }} <br>
                                {{ default_address.country }}    
                            </div>
                            <div class="address-phone">
                                <i class="fas fa-phone me-1"></i>{{ default_address.mobile }}    {% if default_address.second_mobile %}   &nbsp;&nbsp; <i class="fas fa-phone me-1"></i>{{ default_address.second_mobile }}{% endif %}
                            </div>
                            <div class="address-actions">
                                <a href="{% url 'address_update' default_address.id %}?next={{ request.path }}" class="btn btn-edit">
                                    <i class="fas fa-edit me-1"></i>EDIT
                                </a>
                                <!-- <button class="btn btn-edit"></button> -->
                            </div>
                        </div>
                    {% else %}
                        <h3 class="text-muted">No default address. Please add one.</h3><br>
                    {% endif %}

                    <!-- Add New Address Button -->
                     <a href="{% url 'address_create' %}?next={{ request.path }}" class="btn-add-address">
                        <i class="fas fa-plus me-2"></i> ADD NEW ADDRESS
                     </a>
    
       
                </div>

                <!-- Apply Coupon Section -->
                <div class="checkout-card">
                    <h3 class="card-title">
                        <i class="fas fa-ticket-alt"></i>
                        Apply Coupon
                    </h3>
                    
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <input type="text" class="coupon-input w-100" placeholder="Enter Coupon Code" id="couponInput">
                        </div>
                        <div class="col-md-4">
                            <button class="btn-apply-coupon w-100" onclick="applyCoupon()">
                                <i class="fas fa-tags me-1"></i>APPLY
                            </button>
                        </div>
                    </div>
                    
                    <div class="coupon-message" id="couponMessage"></div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            View Coupons: Get extra discounts on your orders
                        </small>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="col-lg-4">
                <div class="order-summary">
                    <h3 class="order-title">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Your Order
                    </h3>
                    
                    <!-- Product Items -->
                    {% for item in basket_items %}
                    <div class="product-item">
                        {% with item.variant.product.images.first as image %}
                            {% if image %}
                                <img src="{{ image.image.url }} " alt="{{ item.variant.product.name }}" class="product-image">
                            {% else %}
                                <img src="{% static 'images/placeholder.png' %}" alt="No Image">
                            {% endif %}
                        {% endwith %}
                        <div class="product-details">
                            <h6>{{ item.variant.product.name }}</h6>
                            <div class="product-qty">Qty: {{ item.quantity }}</div>
                        </div>
                        <div class="product-price">₹{{ item.subtotal|floatformat:2 }}</div>
                    </div>
                    {% empty %}
                    <h2>Your checkout is empty</h2>
                    {% endfor %}

                    <!-- Price Breakdown -->
                    <div class="mt-3">
                        <div class="price-row">
                            <span>Subtotal</span>
                            <span>₹{{ subtotal|floatformat:2  }}</span>
                        </div>
                        <div class="price-row">
                            <span>Shipping</span>
                            {% if shipping == 0 %}
                                <span class="text-success">FREE</span>
                            {% else %}
                                <span>₹{{ shipping|floatformat:2  }}</span>
                            {% endif %}
                        </div>
                        <div class="price-row">
                            <span>Taxes</span>
                            <span>₹{{ taxes|floatformat:2  }}</span>
                        </div>
                        <div class="price-row">
                            <span>Discount</span>
                            <span class="text-warning">₹{{ discount|floatformat:2 }}</span>
                        </div>
                        <div class="price-row total">
                            <span>Total</span>
                            <span>₹{{ total|floatformat:2  }}</span>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="mt-4">
                        
                        <!-- cod -->
                        <form action="{% url 'checkout' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="payment_method" value="wallet">
                            <button type="submit" class="payment-button" >
                                <i class="fas fa-wallet"></i>
                                WALLET
                            </button>
                        </form>

                        <!-- <form action="{{ callback_url }}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="payment_method" value="razorpay">
                            <button type="submit" class="payment-button" id="rzp-button1">
                                <i class="fas fa-credit-card"></i>
                                RAZORPAY
                            </button>
                        </form> -->

                        <form action="{{ callback_url }}" method="POST" id="razorpay-form">
                            {% csrf_token %}
                            <input type="hidden" name="payment_method" value="razorpay">
                            <button type="submit" class="payment-button" id="rzp-button">
                                <i class="fas fa-credit-card"></i>
                                RAZORPAY
                            </button>
                        </form>




                        <form action="{% url 'checkout' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="payment_method" value="cod">
                            <button type="submit" class="payment-button">
                                <i class="fas fa-money-bill-wave"></i>
                                CASH ON DELIVERY
                            </button>
                         </form>

                         



                    </div>


                    <!-- Security Badge -->
                    <div class="text-center mt-3">
                        <small class="security-text">
                            <i class="fas fa-shield-alt me-1"></i>
                            256-bit SSL encrypted & secure payments
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock body %}
{% block extra_js %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
{% if razorpay_order_id %}
<script>
document.getElementById('rzp-button').onclick = function(e){
    var options = {
        "key": "{{ razorpay_merchant_key }}",
        "amount": "{{ razorpay_amount }}",   // in paise
        "currency": "{{ currency }}",
        "name": "POWERBLEND",
        "description": "Order Payment",
        "order_id": "{{ razorpay_order_id }}",
        "prefill": {
            "name": "{{ request.user.full_name }}",
            "email": "{{ request.user.email }}"
        },
        "theme": {"color": "#0c4b65"},
        "handler": function(response){
            var form = document.getElementById('razorpay-form');

            // Append Razorpay data
            var rpid = document.createElement('input');
            rpid.type = 'hidden';
            rpid.name = 'razorpay_payment_id';
            rpid.value = response.razorpay_payment_id;
            form.appendChild(rpid);

            var roid = document.createElement('input');
            roid.type = 'hidden';
            roid.name = 'razorpay_order_id';
            roid.value = response.razorpay_order_id;
            form.appendChild(roid);

            var sig = document.createElement('input');
            sig.type = 'hidden';
            sig.name = 'razorpay_signature';
            sig.value = response.razorpay_signature;
            form.appendChild(sig);

            form.submit();
        }
    };
    var rzp = new Razorpay(options);
    rzp.open();
    e.preventDefault();
};
</script>
{% endif %}

{% endblock extra_js %}