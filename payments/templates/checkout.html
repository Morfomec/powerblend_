{% extends 'payment_base.html' %}
{% load static %}
{% block title %}Checkout - POWERBLEND{% endblock %}
{% block extra_css %}



<style>
/* Base Alert Styles */
.custom-alert {
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    animation: slideDown 0.4s ease-out;
    border: 2px solid rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
}

.custom-alert::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: shimmer 3s infinite;
}

.custom-alert i {
    font-size: 1.1rem;
    animation: pulse 1.5s ease-in-out infinite;
    flex-shrink: 0;
}

/* Error/Danger Alert */
.alert-error {
    background: linear-gradient(135deg, #dc3545, #c82333);
    box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);
}

/* Success Alert */
.alert-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
}

/* Warning Alert */
.alert-warning {
    background: linear-gradient(135deg, #ffc107, #ff9800);
    box-shadow: 0 4px 20px rgba(255, 193, 7, 0.3);
}

/* Info Alert */
.alert-info {
    background: linear-gradient(135deg, #17a2b8, #138496);
    box-shadow: 0 4px 20px rgba(23, 162, 184, 0.3);
}

/* Animations */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.15);
    }
}

@keyframes shimmer {
    0% {
        left: -100%;
    }
    100% {
        left: 100%;
    }
}

/* Solid Background Variants */
.custom-alert.solid.alert-error {
    background: #dc3545;
    border: 2px solid #bd2130;
}

.custom-alert.solid.alert-success {
    background: #28a745;
    border: 2px solid #1e7e34;
}

.custom-alert.solid.alert-warning {
    background: #ffc107;
    border: 2px solid #e0a800;
}

.custom-alert.solid.alert-info {
    background: #17a2b8;
    border: 2px solid #117a8b;
}

/* Light Background Variants with Dark Text */
.custom-alert.light {
    border-left-width: 3px;
}

.custom-alert.light.alert-error {
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
    color: #dc3545;
    border: 2px solid #dc3545;
    border-left-width: 3px;
}

.custom-alert.light.alert-error i {
    color: #dc3545;
}

.custom-alert.light.alert-success {
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
    color: #28a745;
    border: 2px solid #28a745;
    border-left-width: 3px;
}

.custom-alert.light.alert-success i {
    color: #28a745;
}

.custom-alert.light.alert-warning {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
    color: #856404;
    border: 2px solid #ffc107;
    border-left-width: 3px;
}

.custom-alert.light.alert-warning i {
    color: #856404;
}

.custom-alert.light.alert-info {
    background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05));
    color: #17a2b8;
    border: 2px solid #17a2b8;
    border-left-width: 3px;
}

.custom-alert.light.alert-info i {
    color: #17a2b8;
}

/* Responsive */
@media (max-width: 576px) {
    .custom-alert {
        padding: 1rem;
        font-size: 0.9rem;
        gap: 0.5rem;
    }
    
    .custom-alert i {
        font-size: 1.1rem;
    }
}
</style>


{% endblock extra_css %}
{% block body %} 

{% include 'includes/header_user_profile_base.html' %}
    <head><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"></head>


    <div class="checkout-container">
        <div class="row">
            <!-- Left Column - Checkout Form -->
            <div class="col-lg-8">
                <!-- Delivery Address Section -->
                <div class="checkout-card">
                    <h3 class="card-title">i
                        <i class="fas fa-map-marker-alt"></i>
                        Delivery Address
                    </h3>



                    {% if messages %}
                        {% for message in messages %}
                            {% if 'checkout-wallet_insufficient' in message.tags or 'coupon_applied_successfull' in message.tags or 'coupon_applied_not_minimum_meet' in message.tags or 'invalid_coupon' in message.tags or 'otp-success' in message.tags %}
                                <div class="custom-alert 
                                    {% if 'error' in message.tags or 'danger' in message.tags or 'checkout-wallet_insufficient' in message.tags %}alert-error
                                    {% elif 'success' in message.tags or 'otp-success' in message.tags %}alert-success
                                    {% elif 'warning' in message.tags %}alert-warning
                                    {% elif 'info' in message.tags %}alert-info
                                    {% else %}alert-error{% endif %} 
                                    text-uppercase text-center mb-5" id="alert-{{ forloop.counter }}">
                                    <i class="fas 
                                        {% if 'error' in message.tags or 'danger' in message.tags or 'checkout-wallet_insufficient' in message.tags %}fa-exclamation-circle
                                        {% elif 'success' in message.tags or 'otp-success' in message.tags %}fa-check-circle
                                        {% elif 'warning' in message.tags %}fa-exclamation-triangle
                                        {% elif 'info' in message.tags %}fa-info-circle
                                        {% else %}fa-exclamation-circle{% endif %}"></i>
                                    <span>{{ message }}</span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                                        
                    <!-- Existing Address -->
                    {% if default_address %}
                        <div class="address-card selected" onclick="selectAddress(this)">
                            <div class="address-type">
                                {% if default_address.address_type == 'HOME' %}
                                    <i class="fas fa-home me-1"></i>Home
                                {% elif default_address.address_type == 'OFFICE' %}
                                    <i class="fas fa-building me-1"></i>Office
                                {% else %}
                                    <i class="fas fa-map-marker-alt me-1"></i>{{ default_address.address_type|title }}
                                {% endif %}
                            </div>

                            <div class="address-name">{{ default_address.full_name }}</div>
                            <div class="address-details">
                                {{ default_address.address.line1 }}{% if default_address.address_line2 %}, {{ default_address.address_line2 }}{% endif %}<br>
                                {{ default_address.city }}, {{ default_address.state }} {{ default_address.postal_code }} <br>
                                {{ default_address.country }}    
                            </div>
                            <div class="address-phone">
                                <i class="fas fa-phone me-1"></i>{{ default_address.mobile }}    {% if default_address.second_mobile %}   &nbsp;&nbsp; <i class="fas fa-phone me-1"></i>{{ default_address.second_mobile }}{% endif %}
                            </div>
                            <div class="address-actions">
                                <a href="{% url 'address_update' default_address.id %}?next={{ request.path }}" class="btn btn-edit">
                                    <i class="fas fa-edit me-1"></i>EDIT
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <h3 class="text-muted">No default address. Please add one.</h3><br>
                    {% endif %}

                    <!-- Add New Address Button -->
                     <a href="{% url 'address_create' %}?next={{ request.path }}" class="btn-add-address">
                        <i class="fas fa-plus me-2"></i> ADD NEW ADDRESS
                     </a>
                </div>

                <!-- Apply Coupon Section -->
                <div class="checkout-card">
                    <h3 class="card-title">
                        <i class="fas fa-ticket-alt"></i>
                        Apply Coupon
                    </h3>
                    
                    <form method="POST">
                        {% csrf_token %}
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <!-- input name must match form field -->
                                <input type="text" name="code" class="coupon-input w-100" placeholder="Enter Coupon Code" value="{{ coupon_form.code.value }}">
                            </div>
                            <div class="col-md-4">
                                <button type="submit" name="apply_coupon" class="btn-apply-coupon w-100">
                                    <i class="fas fa-tags me-1"></i>APPLY
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="coupon-message" id="couponMessage"></div>
                    
                    <!-- Available Coupons Section -->
                    <div class="available-coupons-section mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="available-coupons-title mb-0">
                                <i class="fas fa-gift me-2"></i>Available Coupons
                            </h5>
                            <button class="btn-view-coupons" onclick="toggleCoupons()">
                                <span id="toggleText">View All</span>
                                <i class="fas fa-chevron-down ms-1" id="toggleIcon"></i>
                            </button>
                        </div>
                        
                        <div class="coupons-list" id="couponsList" style="display: none;">
                            {% if available_coupons %}
                                {% for coupon in available_coupons %}
                                <div class="coupon-card">
                                    <div class="coupon-left">
                                        <div class="coupon-code-badge">{{ coupon.code }}</div>
                                        <div class="coupon-discount">
                                            ₹{{ coupon.discount_amount }} OFF
                                        </div>
                                    </div>
                                    <div class="coupon-middle">
                                        <div class="coupon-description">{{ coupon.description }}</div>
                                        <div class="coupon-details">
                                            {% if coupon.minimum_amount %}
                                                <span class="coupon-condition">
                                                    <i class="fas fa-shopping-cart me-1"></i>Min Order: ₹{{ coupon.minimum_amount }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="coupon-validity">
                                            <i class="fas fa-clock me-1"></i>Valid till: {{ coupon.valid_to|date:"d M, Y" }}
                                        </div>
                                    </div>
                                    <!-- <div class="coupon-right">
                                        <button class="btn-apply-this-coupon" onclick="applyThisCoupon('{{ coupon.code }}')">
                                            APPLY
                                        </button>
                                    </div> -->
                                    <div class="coupon-right">
                                        <button type="button" class="btn-apply-this-coupon" onclick="copyCoupon('{{ coupon.code }}')">
                                            COPY
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-coupons">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>No coupons available at the moment</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="col-lg-4">
                <div class="order-summary">
                    <h3 class="order-title">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Your Order
                    </h3>
                    
                    <!-- Product Items -->
                    {% for item in basket_items %}
                    <div class="product-item">
                        {% with item.variant.product.images.first as image %}
                            {% if image %}
                                <img src="{{ image.image.url }} " alt="{{ item.variant.product.name }}" class="product-image">
                            {% else %}
                                <img src="{% static 'images/placeholder.png' %}" alt="No Image">
                            {% endif %}
                        {% endwith %}
                        <div class="product-details">
                            <h6>{{ item.variant.product.name }}</h6>
                            <div class="product-qty">Qty: {{ item.quantity }}</div>
                        </div>
                        <div class="product-price">₹{{ item.subtotal|floatformat:2 }}</div>
                    </div>
                    {% empty %}
                    <h2>Your checkout is empty</h2>
                    {% endfor %}



                    <!-- Price Breakdown -->
                    <div class="mt-3">
                        <div class="price-row">
                            <span>Subtotal</span>
                            <span>₹{{ subtotal|floatformat:2  }}</span>
                        </div>
                        <div class="price-row">
                            <span>Shipping</span>
                            {% if shipping == 0 %}
                                <span class="text-success">FREE</span>
                            {% else %}
                                <span>₹{{ shipping|floatformat:2  }}</span>
                            {% endif %}
                        </div>
                        <div class="price-row">
                            <span>Taxes</span>
                            <span>₹{{ taxes|floatformat:2  }}</span>
                        </div>
                        <div class="price-row-wrapper">
                            <div class="price-row">
                                {% if applied_coupon %}
                                    <span>Coupon ({{ applied_coupon.code }})</span>
                                    <span class="text-warning">-₹{{ discount|floatformat:2 }}</span>
                                {% else %}                    

                                    <span>Discount</span>
                                    <span class="text-warning">₹0.00</span>
                                {% endif %}                               
                            </div>
                            {% if applied_coupon %}
                                <form method="POST" class="remove-coupon-form">
                                    {% csrf_token %}
                                    <button type="submit" name="remove_coupon" class="btn-remove-coupon">
                                        <i class="fas fa-times-circle me-1"></i>Remove Coupon
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                        <div class="price-row total">
                            <span>Total</span>
                            <span>₹{{ total|floatformat:2  }}</span>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="mt-4">
                        <form action="{% url 'checkout' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="payment_method" value="wallet">
                            <button type="submit" class="payment-button" >
                                <i class="fas fa-wallet"></i>
                                WALLET
                            </button>
                        </form>

                        <form action="{{ callback_url }}" method="POST" id="razorpay-form">
                            {% csrf_token %}
                            <input type="hidden" name="payment_method" value="razorpay">
                            <button type="submit" class="payment-button" id="rzp-button">
                                <i class="fas fa-credit-card"></i>
                                RAZORPAY
                            </button>
                        </form>

                        <form action="{% url 'checkout' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="payment_method" value="cod">
                            <button type="submit" class="payment-button">
                                <i class="fas fa-money-bill-wave"></i>
                                CASH ON DELIVERY
                            </button>
                         </form>
                    </div>

                    <!-- Security Badge -->
                    <div class="text-center mt-3">
                        <small class="security-text">
                            <i class="fas fa-shield-alt me-1"></i>
                            256-bit SSL encrypted & secure payments
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock body %}

{% block extra_js %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>


{% if razorpay_order_id %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    
document.getElementById('rzp-button').onclick = function(e){
    var options = {
        "key": "{{ razorpay_merchant_key }}",
        "amount": {{ razorpay_amount }},
        "currency": "{{ currency }}",
        "name": "POWERBLEND",
        "description": "Order Payment",
        "order_id": "{{ razorpay_order_id }}",
        "prefill": {
            "name": "{{ request.user.full_name }}",
            "email": "{{ request.user.email }}"
        },
        "theme": {"color": "#0c4b65"},
        "handler": function(response){
            var form = document.getElementById('razorpay-form');

            ['razorpay_payment_id','razorpay_order_id','razorpay_signature'].forEach(function(name){
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = response[name];
                form.appendChild(input);
            });

            form.submit();
        }
    };
    var rzp = new Razorpay(options);
    rzp.open();
    e.preventDefault();
};
</script>


{% endif %}

<script>
function toggleCoupons() {
    const couponsList = document.getElementById('couponsList');
    const toggleText = document.getElementById('toggleText');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (couponsList.style.display === 'none') {
        couponsList.style.display = 'block';
        toggleText.textContent = 'Hide';
        toggleIcon.classList.remove('fa-chevron-down');
        toggleIcon.classList.add('fa-chevron-up');
    } else {
        couponsList.style.display = 'none';
        toggleText.textContent = 'View All';
        toggleIcon.classList.remove('fa-chevron-up');
        toggleIcon.classList.add('fa-chevron-down');
    }
}

function applyThisCoupon(code) {
    document.getElementById('couponInput').value = code;
    applyCoupon();
}

function copyCoupon(code) {
    navigator.clipboard.writeText(code).then(() => {
        toastr.success('Coupon code copied: ' + code);
    }).catch(() => {
        toastr.error('Failed to copy coupon code');
    });
}
</script>

<!-- Optional: Auto-dismiss script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const alert = document.getElementById('alert');
    if (alert) {
        // Auto-dismiss after 5 seconds
        setTimeout(function() {
            alert.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-20px)';
            setTimeout(function() {
                alert.remove();
            }, 500);
        }, 5000);
    }
});
</script>
{% endblock extra_js %}